<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>crawler &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="crawler"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="http://blog.jln.co/tags/crawler/"><meta property="og:image" content="http://blog.jln.co/images/avatar.png"><meta property="og:updated_time" content="2017-02-07T17:18:05+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.jln.co/images/avatar.png"><meta name=twitter:title content="crawler"><meta name=twitter:description content><link rel=canonical href=http://blog.jln.co/tags/crawler/><link href=http://blog.jln.co/tags/crawler/feed.xml rel=alternate type=application/rss+xml title="Le murmure de Julian"><link href=http://blog.jln.co/tags/crawler/feed.xml rel=feed type=application/rss+xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.73.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post-index><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i>Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i>GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i>Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>crawler</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-02-07 17:18:05 +0000 UTC"><a href=/Swift-%E6%BC%AB%E7%95%AB%E7%88%AC%E8%9F%B2/>Feb 7, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>Reading time ~5 minutes</span></div><h1 class=entry-title><a href=/Swift-%E6%BC%AB%E7%95%AB%E7%88%AC%E8%9F%B2/ rel=bookmark title="[Swift] 漫畫爬蟲" itemprop=url>[Swift] 漫畫爬蟲</a></h1></header><div class=entry-content><p>最近搬家又讓我挖出了Amazon Kindle, 又覺得拿來看漫畫很方便(這戲演了幾次了呀?), 雖然說好像也有網站可以下載漫畫.mobi檔, 不過似乎是會員制的, 不喜歡</p><p>因此又讓我想寫漫畫的爬蟲了, 這次的目標是: <a href=http://www.comicbus.com/>無限動漫</a> (他們的app實在做得有夠差)</p><p>這次幾個需求是:</p><ol><li>Command line下就可以跑了(這也沒必要做UI吧?)</li><li>在os x下可以執行(我自己電腦是mac)</li><li>出來的檔案可以放到kindle看(.mobi檔或epub)</li></ol><p>mobi或epub的檔案格式似乎有點麻煩, 也不太好做得好, 所以決定用cbz檔再用<a href=https://calibre-ebook.com/>Calibre</a>轉mobi</p><p><a href=https://calibre-ebook.com/>Calibre</a>有一個方便的command line tool叫ebook-convert, 可以用來轉檔, 而cbz本身非常的簡單
, 它就是一個zip檔, 裡面的圖片檔名照編號就好, 這code還算好寫</p><p>再來就是看一下怎麼解析<a href=http://www.comicbus.com/>無限動漫</a>的內容了, 它的URL是長這樣的:</p><pre><code>http://v.comicbus.com/online/comic-653.html?ch=1
</code></pre><p>以上範例是名偵探柯南第一卷, 大膽猜測, 653是漫畫編號, ch是集數, 選到第二頁, URL會變成這樣</p><pre><code>http://v.comicbus.com/online/comic-653.html?ch=4-2
</code></pre><p>這樣其實就很明顯了, 接下來是內容的部分</p><p>每一集的頭上有一個"正在觀看:[ 名偵探柯南 1 ]&rdquo;, &ldquo;[]&ldquo;內就是標題了吧, 另外還有一個"select&rdquo;, 裡面有這集所有的頁數資訊, 而圖片的id是"TheImg&rdquo;</p><p>不過麻煩的是, 這些資訊似乎隱藏在javascript中, page載入後才會出現</p><p>這如果使用headless browser像是<a href=http://phantomjs.org/>Phantomjs</a>就沒啥問題, 但這邊我不想用它, 因為使用這工具還要再裝它</p><p>我下一個選擇是Go + <a href=https://github.com/sourcegraph/webloop>Webloop</a>, <a href=https://github.com/sourcegraph/webloop>Webloop</a>是一個Go的headless browser lib, 它是基於WebkitGtk+做成的,
不過我在mac上裝WebkitGTK+裝好久一直有問題, 所以&mldr;放棄&mldr;.</p><p>接下來的選擇呢? 還有其他的headless browser嗎?有的! <a href=https://github.com/phimage/Erik>Erik</a>, 這是一個Swift的head less browser,
用Swift寫爬蟲好像挺酷的, 查了一下, 有人用<a href=https://github.com/Alamofire/Alamofire>Alamofire</a> + <a href=https://github.com/tid-kijyun/Kanna>Kanna</a>, 不過這在這例子不適用, 這例子還是比較適合<a href=https://github.com/phimage/Erik>Erik</a></p><h3 id=成品>成品</h3><p>先給成果: <a href="https://drive.google.com/open?id=0B5rbRldWhe82MWRnVkpMQlExTHc">ComicGo</a></p><p>這已經是一個OS X的可執行檔, 在Command line下執行 <code>ComicGo 653 1</code>就可以抓名偵探柯南第一集, 相關的漫畫編號集數, 就去<a href=http://www.comicbus.com/>無限動漫</a>查吧</p><p>抓完會在你的Download目錄出現"名偵探柯南 1.cbz"再用ebook-covert去轉成你要的格式就可以了</p><p>少少的時間隨便寫寫而已, 有bug就見諒囉</p><h3 id=os-x-command-line-tool>OS X Command line tool</h3><p>XCode + Swift是可以拿來寫command line tool的, 新增一個專案選"Command line tool&rdquo;:</p><p><img src=/images/posts/xcodecmd.png alt></p><p>這樣就可以開始寫了</p><p>一開始在專案內部會發現一個"main.swift&rdquo;, 由於用swift寫command line app並沒有像其他語言有main function這類的東西
所以程式就寫在這吧</p><h3 id=開發command-line-tool的坑>開發Command line tool的坑</h3><p>坑&mldr;真的不少</p><p>首先, 你不能使用任何的framework, 因為command line tool產出會是一個可執行檔, 不是一個app bundle, 所以不能包含任何的framework</p><p>第二, swift framework不能static link, 像是Erik, Kanna這些swift module, 都是dynamic lib</p><p>慘, 光前面這兩點就麻煩了, 開發這個ComicGo, 我用到了<a href=https://github.com/phimage/Erik>Erik</a>, <a href=https://github.com/tid-kijyun/Kanna>Kanna</a>, <a href=https://github.com/marmelroy/Zip>Zip</a>等等
, 這樣到底要怎麼辦? 跑起來就image not found</p><p>所以呢?土法煉鋼, 把這些module的codes全部引入到我的專案內(所以沒打算Open ssource, 太醜了), 這樣一來就解決掉問題了, 不過這功不算小, 因為Kanna相依libxml, Zip相依libz這些native lib</p><p>第三個坑, Erik是利用OS X裡面原生的WebKit去讀取網頁的, 因此他的設計是把載入網頁放到另一個DispatchQueue(javascript執行又是另一個),
但Command line邏輯很單線, 它並不會等callback回來才結束程式, 因此會發現怎麼Erik都沒動作就結束程式了, 因此必須要有個機制來卡住</p><p>這個機制就是<a href="https://www.google.com.tw/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=swift+runloop">RunLoop</a>, 關於RunLoop這邊不多做解釋, 看一下<a href="https://www.google.com.tw/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=swift+runloop">官方文件</a>
在程式內則是這樣:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#66d9ef>let</span> rl = RunLoop.current
<span style=color:#66d9ef>var</span> finished = <span style=color:#66d9ef>false</span>

<span style=color:#66d9ef>while</span> <span style=color:#f92672>!</span>finished {
    rl.run(mode: RunLoopMode.defaultRunLoopMode, before: Date(timeIntervalSinceNow: <span style=color:#ae81ff>2</span>))
}
</code></pre></div><p>當callback完畢後, 把finished設成true就可以結束整個程式了</p><h3 id=erik>Erik</h3><p>好像還沒介紹<a href=https://github.com/phimage/Erik>Erik</a>喔?其實有點想偷懶跳過了 :P</p><p>使用<a href=https://github.com/phimage/Erik>Erik</a>來爬網頁其實很簡單,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift>Erik.visit(url: url) { object, error <span style=color:#66d9ef>in</span>
    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> e = error {

    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> doc = object {
        <span style=color:#75715e>// HTML Inspection</span>
		<span style=color:#66d9ef>for</span> link <span style=color:#66d9ef>in</span> doc.querySelectorAll(<span style=color:#e6db74>&#34;a, link&#34;</span>) {
    		print(link.text)
    		print(link[<span style=color:#e6db74>&#34;href&#34;</span>])
		}
    }
}
</code></pre></div><p>只要有些CSS selector的觀念就可以了, 連querySelectorAll這名字都是一樣的, Erik並不是直接用Webkit去做CSS query的, 而是把webkit的內容拿來用<a href=https://github.com/tid-kijyun/Kanna>Kanna</a>解析,
javascript的執行也一樣, 因此如果對html node有任何變動, 是不會反映到webkit裡面去的, 用Erik來爬的優點是專門針對那些動態網頁的, 有這個就簡單太多了!</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-01-19 11:45:30 +0000 UTC"><a href=/Go-%E7%94%A8Go%E6%8A%93PTT%E6%96%87%E7%AB%A0/>Jan 19, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/Go-%E7%94%A8Go%E6%8A%93PTT%E6%96%87%E7%AB%A0/ rel=bookmark title="[Go] 用Go抓PTT文章" itemprop=url>[Go] 用Go抓PTT文章</a></h1></header><div class=entry-content><p>好, 這算我以為我寫過但實際上沒有系列&mldr;.啥? 剛剛把我以前寫的一個<a href=https://github.com/julianshen/gopttcrawler>Go package - gopttcrawler</a>更新後,
想說之前好像有寫過相關文章, 但實際上又沒找到(老了?)</p><p>沒關係, 把Readme拿來貼一貼就可以混一篇文了(混蛋!!!偷懶!!!)</p><p><a href=https://github.com/julianshen/gopttcrawler>gopttcrawler</a></p><p>這是我在新聞萬事通裡面用來抓取ptt文章的, 用法也很簡單, 基本上看最後兩種用法就好, 自己個人覺得那比較好用</p><p>原本的版本並沒處理18+那個擋在前面的畫面, 查了一下很多人(在python)的做法是去發post取得cookie, 再帶cookie去取, 後來發現, cookie是固定的, 只要這樣就好:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>cookie</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Cookie</span>{
		<span style=color:#a6e22e>Name</span>:  <span style=color:#e6db74>&#34;over18&#34;</span>,
		<span style=color:#a6e22e>Value</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
	}
	<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>AddCookie</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cookie</span>)
</code></pre></div><p>所以現在像是八卦版這種18+的也可以抓取了</p><p>安裝方法: <code>go get -u github.com/julianshen/gopttcrawler</code></p><p>使用方法請參考sample.go或是ptt_test.go</p><h4 id=資料結構>資料結構</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Article</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>ID</span>       <span style=color:#66d9ef>string</span> <span style=color:#75715e>//Article ID
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Board</span>    <span style=color:#66d9ef>string</span> <span style=color:#75715e>//Board name
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Title</span>    <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Content</span>  <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Author</span>   <span style=color:#66d9ef>string</span> <span style=color:#75715e>//Author ID
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>DateTime</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Nrec</span>     <span style=color:#66d9ef>int</span> <span style=color:#75715e>//推文數(推-噓)
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArticleList</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Articles</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>Article</span> <span style=color:#75715e>//Articles
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Board</span>        <span style=color:#66d9ef>string</span> <span style=color:#75715e>//Board
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>PreviousPage</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//Previous page id
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>NextPage</span>     <span style=color:#66d9ef>int</span> <span style=color:#75715e>//Next page id
</span><span style=color:#75715e></span>}
</code></pre></div><h4 id=載入文章列表>載入文章列表</h4><ol><li>載入最新一頁表特版文章</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#a6e22e>articleList</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gopttcrawler</span>.<span style=color:#a6e22e>GetArticles</span>(<span style=color:#e6db74>&#34;Beauty&#34;</span>, <span style=color:#ae81ff>0</span>)
    <span style=color:#75715e>// the 1st parameter is the board name
</span><span style=color:#75715e></span>    <span style=color:#75715e>// the 2nd parameter is the page id. 0 indicates the latest page
</span></code></pre></div><ol start=2><li>載入前一頁文章列表</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#a6e22e>prevArticleList</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>articleList</span>.<span style=color:#a6e22e>GetFromPreviousPage</span>()
</code></pre></div><h4 id=載入文章內容>載入文章內容</h4><ol><li>載入單篇文章詳細內容</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#a6e22e>article</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>articleList</span>.<span style=color:#a6e22e>Articles</span>[<span style=color:#ae81ff>0</span>]
    <span style=color:#a6e22e>article</span>.<span style=color:#a6e22e>Load</span>()
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>article</span>.<span style=color:#a6e22e>Content</span>) <span style=color:#75715e>//印出內文(html)
</span></code></pre></div><ol start=2><li>取得文章中所有圖片連結</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#a6e22e>images</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>article</span>.<span style=color:#a6e22e>GetImageUrls</span>()
</code></pre></div><ol start=3><li>取得文章中的連結</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#a6e22e>links</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>article</span>.<span style=color:#a6e22e>GetLinks</span>()
</code></pre></div><h4 id=iterator>Iterator</h4><p>新增Iterator功能:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>100</span>

	<span style=color:#a6e22e>articles</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gopttcrawler</span>.<span style=color:#a6e22e>GetArticles</span>(<span style=color:#e6db74>&#34;movie&#34;</span>, <span style=color:#ae81ff>0</span>)
	
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#f92672>...</span>.
	}

	<span style=color:#a6e22e>iterator</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>articles</span>.<span style=color:#a6e22e>Iterator</span>()

	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
	<span style=color:#66d9ef>for</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>article</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>iterator</span>.<span style=color:#a6e22e>Next</span>(); <span style=color:#a6e22e>e</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
				<span style=color:#66d9ef>break</span>
			}
			<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>

			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%v %v&#34;</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>article</span>)
		}
	}
</code></pre></div><p>上面這範例是抓取最新的100篇文章, 不用管第幾頁, 或是上一頁下一頁, 反正就一直抓</p><h4 id=go-routine版本的getarticles>Go routine版本的GetArticles</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gopttcrawler</span>.<span style=color:#a6e22e>GetArticlesGo</span>(<span style=color:#e6db74>&#34;Beauty&#34;</span>, <span style=color:#ae81ff>0</span>)
	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>100</span>
	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>article</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ch</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
			<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
			<span style=color:#66d9ef>break</span>
		}
		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%v %v&#34;</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>article</span>)
	}
</code></pre></div><p>這範例一樣也是抓一百篇, 只是抓文章的部分被放到go routine去了, 會立即回傳兩個channel,
第一個是receive only channel, 跟Iterator類似, 一次拿一篇文章, 可以用range, 第二個是一個bool channel, 拿夠了送個訊息通知他終止go routine,
如果把receive部分放到select去, 就是non blocking了, 不會被讀上一頁下一頁的IO給卡住</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-10-04 23:41:22 +0000 UTC"><a href=/%E4%B8%80%E4%BA%9B%E5%81%9A%E7%88%AC%E8%9F%B2%E7%9A%84%E5%B7%A5%E5%85%B7%E8%88%87%E6%96%B9%E6%B3%95/>Oct 4, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>Reading time ~9 minutes</span></div><h1 class=entry-title><a href=/%E4%B8%80%E4%BA%9B%E5%81%9A%E7%88%AC%E8%9F%B2%E7%9A%84%E5%B7%A5%E5%85%B7%E8%88%87%E6%96%B9%E6%B3%95/ rel=bookmark title=一些做爬蟲的工具與方法 itemprop=url>一些做爬蟲的工具與方法</a></h1></header><div class=entry-content><p>之前寫了一些爬蟲, 想說來補一篇這樣的文章好了</p><p>可能是之前"所謂"的大數據(Big Data)太過流行, 以至於網路爬蟲好像是一種顯學, 隨便Google一下都可以找到一堆用python加上<a href=https://www.crummy.com/software/BeautifulSoup/bs4/doc/#>BeautifulSoup</a>
相關的文章, 這可能也是因為, 現在網路上的資料, Open data的, 提供API的, 在比例上還是非常的少數, 但網頁的數量真的多到很難統計(想到早期還真是屈指可數)
要取得網頁內的內容, 解析HTML, 做字串的處理就是一個必要的基礎, 這也難怪python + <a href=https://www.crummy.com/software/BeautifulSoup/bs4/doc/#>BeautifulSoup</a>
一直廣泛的被採用</p><p>不過, 當你真的去寫一個爬蟲, 突然就會發現了, 代誌不是這麼單純呀, 不是去抓個html回來解析一下就有自己想要的資料了呀, 而是會發現, 怎麼大家正正當當的網頁不寫,
一堆奇技淫巧, 繞來繞去的, 網頁廣告內容也一堆, 很多網頁都很難抓到自己想要的資料呀!!!</p><p>真的來說, 做爬蟲是一種Hacking的活動, 天下網頁萬萬種, 為了總總不同的目的, 早已不是幾個簡單的html標籤就做出來的了, 還搭配了很多程式的技巧在內,
因此要從裡面萃取資料出來, 常常還真的是要無所不用其極</p><h3 id=那到底做爬蟲會先需要懂什麼>那到底做爬蟲會先需要懂什麼?</h3><ol><li>HTML</li><li>CSS</li><li>DOM</li><li>DOM Selectors</li><li>Javascript</li><li>Regular Expression (正規表示式)</li><li>Chrome dev tool</li><li>Curl</li></ol><p>以上這幾個東西可能是基本必須懂得, 而不是程式語言, 那反而其次, 很多程式語言都有很好的能力跟工具來做, 另外需要具備的是耐心, 眼力, 直覺, 和運氣</p><p>底下就拿我之前弄過的幾個東西當範例, 由於我寫比較多Go和nodejs, 所以就不用(主流的)Python來做範例了</p><h3 id=範例一--文章內容分析-如新聞-部落格文章等等>範例一 : 文章內容分析 (如新聞, 部落格文章等等)</h3><p>這應該是比較常見的應用, 單純抓取文章內容去做分析, 常碰到的麻煩是現在網站放了大大小小的(補釘)廣告, 那些跟內容不相干, 也不會是我們想拿來分析的目標</p><p>底下這個範例是從Yahoo! News的RSS抓取新聞文章連結, 再從這些連結的文章內找出關鍵字:</p><script type=application/javascript src=https://gist.github.com/julianshen/2c21aa1e83e1e7b20f0d2560600383f2.js></script><p>這段code非常的簡單, 主要也只用到以下這幾種東西:</p><ol><li>rss parser</li><li><a href=https://github.com/mauidude/go-readability>go-readability</a></li><li><a href=https://github.com/yanyiwu/gojieba>結巴</a></li></ol><p>簡單的來說就是先從rss內找出所有新聞的連結再一個個去爬, 然後用<a href=https://github.com/mauidude/go-readability>go-readability</a>精簡出網頁內文, 再用<a href=https://github.com/yanyiwu/gojieba>結巴</a>取出關鍵字</p><h4 id=readability>readability</h4><p>這一個library以往的用途就是清除不必要的html tags跟內容(像是廣告), 只留下易讀的內文（純文字), 以這個例子來說, 這是一個最適合的工具了</p><p>最早的readability應該是<a href=https://www.readability.com/arc90/>arc90</a>這人開源出來的, 最早應該是javascript的版本,
但就算你不是用javascript, 它老早也被翻唱成其他語言的版本了, 像是:</p><ol><li>Python - <a href=https://github.com/timbertson/python-readability>python-readability</a></li><li>Node.js - <a href=https://github.com/luin/readability>node.js readability</a></li><li>Java - <a href=https://github.com/wuman/JReadability>JReadability</a> 和 <a href=https://github.com/karussell/snacktory>snacktory</a></li><li>Go - <a href=https://github.com/mauidude/go-readability>go-readability</a></li></ol><h4 id=結巴-jieba>結巴 jieba</h4><p><a href=https://github.com/fxsjy/jieba>結巴 jieba</a> 是一個用在做中文分詞的工具, 英文每個單詞都是用空白分開的, 但中文就不是那麼回事了, <a href=https://github.com/fxsjy/jieba>結巴 jieba</a> 可以幫忙作掉這部份的工作, 這可以拿來做文章分析或是找關鍵字用</p><p>一樣有好幾種語言的版本 - Java, C++, Node.js, Erlang, R, iOS, PHP, C#, Go (參照結巴的說明內文), 算蠻齊全的了</p><h3 id=範例二--抓取bilibili的視訊檔位址>範例二 : 抓取Bilibili的視訊檔位址</h3><p>這個範例稍微做了點弊, 但還是從頭把分析過程來講一下好了</p><p>Bilibili視頻網頁長得就像這樣: <a href=http://www.bilibili.com/video/av6467776/>範例 - http://www.bilibili.com/video/av6467776/</a></p><p>先簡單的從網址猜一下&mldr;.&ldquo;av6467776"應該是某個ID之類的東西, 再進一步, ID可能就是這個"6467776&rdquo;</p><p>接下來我們就需要借助一下<a href=https://developer.chrome.com/devtools>Chrome的"開發人員工具&rdquo;</a>, 這是一個強大也重要的工具, 不要只傻傻的用View source而已, View source能看到的也只有原始HTML的內容</p><p>開了網頁後, 用Ctrl+Shift+I (windows)或是Cmd+Opt+I (mac)打開他, 打開後先選到elements, 像這樣:</p><p><img src=/images/posts/crw_1.jpg alt="Chrome devtools elements"></p><p>這邊標示了四個部分, 先點選了<strong>1</strong>, 再用滑鼠游標點你想知道的元件(以這邊來說是那個視訊框 <strong>2</strong> 的地方), 然後他就會幫你跳到相關的HTML位置（如<strong>3</strong>), 而<strong>4</strong>所標示出的是css屬性</p><p>把object這部份點開, 果然, 在flashvars那邊我們可以找到"cid=10519268&aid=6467776&pre_ad=0"這樣的字串, 表示"6467776"的確是某種叫aid的東西,
但, 這不代表找到結案了!! 我們再用curl檢查一下:</p><pre><code>curl http://www.bilibili.com/video/av6467776/ --compressed
</code></pre><p>抓原始的html檔來比對一下(可以把這指令的輸出存成檔案在來看會方便點), 怎麼沒"object"這標籤呀?到哪去了?可見剛剛那段html是某段javascript去產生的</p><p>再回頭看DevTools上object那段, 可以發現它是一個div包起來的, 這div的class是scontent, id是bofqi, 再回頭去看原始的HTML, 整段也只有一個這樣的block, 內容是這樣:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;scontent&#34;</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bofqi&#34;</span>&gt;
    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;player_placeholder&#39;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;player&#39;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;
&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/javascript&#39;</span>&gt;<span style=color:#a6e22e>EmbedPlayer</span>(<span style=color:#e6db74>&#39;player&#39;</span>, <span style=color:#e6db74>&#34;http://static.hdslb.com/play.swf&#34;</span>, <span style=color:#e6db74>&#34;cid=10519268&amp;aid=6467776&amp;pre_ad=0&#34;</span>);&lt;/<span style=color:#f92672>script</span>&gt;
    &lt;/<span style=color:#f92672>div</span>&gt;
</code></pre></div><p>OK, 這邊就很容易可以確定從scontent這區塊就可以找到兩個id - aid和cid , 但這能做什麼用? 還不知道</p><p>接著切換到Network那邊去, 然後再重新整理一下頁面:</p><p><img src=/images/posts/crw_2.jpg alt="Chrome devtools network"></p><p>左下角的部分是瀏覽器在畫出這個頁面所載入的內容跟檔案, 一開使用時序排序的, 當然你可以用其他方式排序, 這邊就是可以挖寶的地方了</p><p>先看到上面那一堆長長短短的線, 這是瀏覽器載入檔案的時間線, 點選這邊可以只看特定時間區間的部分, 最後面可以發現有一條長長的藍線, 那可能就是視訊檔了(因為通常較大), 因此我們可知這視訊檔的URL是</p><pre><code>http://61.221.181.215/ws.acgvideo.com/3/46/10519268-1.flv?wsTime=1475663926&amp;wsSecret2=893ba83b8f13d8700d2ae0cddab96c55&amp;oi=3699654085&amp;rate=0&amp;wshc_tag=0&amp;wsts_tag=57f467b8&amp;wsid_tag=dc843dc5&amp;wsiphost=ipdbm
</code></pre><p>但這串怎麼來的, 依我們手上只有兩個id的資訊是拼湊不起來的, 它一定從某個地方由這兩個id轉換出來的(合理的猜測), 因此, 我們可以再把aid, cid拿去搜尋檔案(點選檔案列表那區塊, 按ctrl-f或command-f開搜尋框)</p><p>一個個看, 找出可能的檔案, 由於aid可以找出22個結果而cid只有10個, 從cid開始找起會比較簡單點, 這邊篩選出幾個可能性:</p><ol><li><a href="http://interface.bilibili.com/player?id=cid:10519268&aid=6467776">http://interface.bilibili.com/player?id=cid:10519268&aid=6467776</a> - 回傳是一個xml, 有一些相關資訊, 但沒影片位址</li><li><a href="http://interface.bilibili.com/playurl?accel=1&cid=10519268&player=1&ts=1475635126&sign=e1e2ae9d2d34e4be94f46f77a4a107ce">http://interface.bilibili.com/playurl?accel=1&cid=10519268&player=1&ts=1475635126&sign=e1e2ae9d2d34e4be94f46f77a4a107ce</a> - 從這回傳裡面有個durl > url, 跟上面url比對, 似乎就是他了, 後面再來講這段</li><li><a href=http://comment.bilibili.com/playtag,10519268>http://comment.bilibili.com/playtag,10519268</a> - 這應該是"看过该视频的还喜欢"裡的內容</li><li><a href=http://comment.bilibili.com/10519268.xml>http://comment.bilibili.com/10519268.xml</a> - 喔喔喔, 看起來這就是彈幕檔喔!</li><li><a href=http://comment.bilibili.com/recommendnew,6467776>http://comment.bilibili.com/recommendnew,6467776</a> - 這似乎是推薦視頻的內容</li><li><a href="http://api.bilibili.com/x/tag/archive/tags?jsonp=jsonp&aid=6467776&nomid=1">http://api.bilibili.com/x/tag/archive/tags?jsonp=jsonp&aid=6467776&nomid=1</a> - 看起來這是tag</li></ol><p>看來, <strong>2</strong> 應該就是我們所要的了, 不過這邊有兩個麻煩, 一個是&mldr;我討厭XML!!!!!不過這好像還好, 似乎有個HTML5版本, 點點看好了, 果不其然, 發現另一個:</p><pre><code>https://interface.bilibili.com/playurl?cid=10519268&amp;appkey=6f90a59ac58a4123&amp;otype=json&amp;type=flv&amp;quality=3&amp;sign=571f239a0a3d4c304e8ea0e0f255992a
</code></pre><p>表示我們是可以用otype=json來抓取json格式的, 但後面這個更麻煩了, 那個sign是什麼東西? 從他有個appkey來看, 合理的猜測, 他是某種API的signature, 通常這種東西的規則是把所有的參數先依名字排序成新的query string, 加上某個secret, 再算出他的MD5即是他的sign</p><p>但如果真是這樣, 這下有點麻煩, 到哪裡找這個secret, 不過凡走過必有痕跡, 這串既然是由瀏覽器端產生的, 那應該會在哪裡找到點線索, 或許可以先用appkey的內容去每個javascript檔案搜尋吧</p><p>不過, 不出所料, 找不到, 那, 還有一個可能性, 它寫在flash內, 從上面抓到的資訊來看, 他的flash檔案應該是: <a href=http://static.hdslb.com/play.swf>http://static.hdslb.com/play.swf</a></p><p>可以把它抓回來反編譯(decompile), 有個工具叫<a href=https://www.free-decompiler.com/flash/>JPEX Flash decompiler</a>的, 可以做到這件事</p><p><img src=/images/posts/crw_3.jpg alt=JPEX></p><p>在script裡面有它的程式原始碼, 應該可以在裡面找到, 不過有點辛苦, 因為你也沒辦法從appkey找到那個secret, 這邊直接跳轉答案, 應該就如同截圖所示是"com.bilibili.interfaces.getSign"這邊, 只是被混淆到很難看, 看得很頭痛, 會短命的</p><p>理論上, 把這段源碼翻譯一遍後應該就解決了, 但一來我看不太懂action script, 二來我實在懶得看, 想偷懶, 有沒作弊的方法? 凡走過必留下痕跡嘛, 一定還會有前人走過這條路, 所以直接把"6f90a59ac58a4123"這串appkey拿去搜尋, 果然, 找到secret了, 寫個程式驗證一下, 果然是沒錯的</p><script type=application/javascript src=https://gist.github.com/julianshen/137c3584ef805ae5cf74147ae737b697.js></script><h3 id=範例三-楓林網http8dramacom>範例三: <a href=http://8drama.com>楓林網</a></h3><p><a href=http://8drama.com>楓林網</a>是一個非法的電視劇來源, 有相當齊全的電視劇內容, 我這個是之前寫的一個工具了, 可以把一整部劇可以抓回本地端, 原始碼跟使用方法在這:</p><ul><li><a href=https://github.com/julianshen/d8>d8 - https://github.com/julianshen/d8</a></li></ul><p>這邊就不再說明怎麼使用它了, 主要著重它是怎做出來的, 這一個跟上面幾個不一樣的地方在於我是用nodejs寫的, 之所以用nodejs是有原因的, 後面再解釋, 主要的程式碼在<a href=https://github.com/julianshen/d8/blob/master/88.js>88.js</a></p><p>楓林網的電視劇集的網址長成這樣: <a href=http://8drama.com/178372/>http://8drama.com/178372/</a> , 當然178372又是ID了, 但它裡面所有的東西ID長得都是一個樣, 一整部劇跟單一集的ID都是同一個格式, 所以是無法從ID判斷出他是哪類</p><p>一樣打開Chrome DevTools, 點選到每一集的列表區塊, 我們可以發現在""裡面的可以找到每一集的URL, 而他的格式都是http://8drama.com/(ID), 所以我們可以輕易的用regular expression分辨出來</p><p>接下來就要掃每一集的內容把影片檔找出來了</p><p>當然可以用前面的方法試試看, 不過那方法在這邊沒啥用, 因為這邊影片的網址編碼是用好多亂七八糟的javascript堆積起來, 沒記錯的話, 我是從<a href=http://8drama.com/play5/video.js>video.js</a>找到線索的(這有點時間之前做的了, 有點沒印象了)</p><p>所以該怎麼面對那一大段javascript的code呢? 這就是我這工具為何選nodejs的原因了, 抄過來就好了!!! 去除掉跟瀏覽器相關的部分, 它就是不折不扣nodejs可以跑的程式碼, 所以這也就是<a href=https://github.com/julianshen/d8/blob/master/88.js>88.js</a>一些怪怪程式碼的由來</p><p>除了這版本外, 我本來也有想要做一個Java的版本, 做了一半, 用Java也是可以用類似的技巧, 不過就得要導入Javascript的runtime了, 而我採用的是<a href=https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino>Mozilla Rhino</a></p><h3 id=更進階一點的>更進階一點的</h3><p>做爬蟲大部分的時間都是要跟html, javascript, css這類的東西搏鬥, 但其實很多東西本來就是原本瀏覽器就會處理的, 因此如果可以直接用瀏覽器或甚至是WebKit來處理, 可以處理的事應該就會多一點, 這時候就可以利用所謂的Headless browser來簡化, 這種東西本來是用在網頁自動化測試的, 不過, 用在這應用也一樣強大, 這類的解決方案有:</p><ol><li><a href=http://phantomjs.org/>Phantomjs</a> - 這是以WebKit為基礎的, 我比較常用</li><li><a href=http://slimerjs.org/>Slimerjs</a> - 這是以Mozilla Geco為基礎的</li><li><a href=http://www.seleniumhq.org/>Selenium</a></li><li><a href=https://github.com/sourcegraph/webloop>Webloop</a> - Go版本的</li></ol><p>關於<a href=http://phantomjs.org/>Phantomjs</a>的應用, 我很久之前已經有寫過一篇了:</p><p><a href=http://blog.jln.co/%E9%A2%B1%E9%A2%A8%E5%A4%A9%E7%9A%84%E5%AE%85code%E6%95%99%E5%AD%B8-%E6%8A%93%E6%BC%AB%E7%95%AB/>颱風天的宅code教學: 抓漫畫</a></p><h3 id=android上呢>Android上呢?</h3><p>Java上, 大多是用<a href=https://jsoup.org/>jsoup</a>來解析html的, 像我之前這篇:</p><p><a href=http://blog.jln.co/android-%E5%9C%9F%E8%A3%BDplay-store-api/>[Android] 土製Play store API</a></p><p>當然應該也是可以用Webkit/WebView做成headless的解決方案, 不過這部份我目前還沒試過, 留待以後有機會再試吧</p></div></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="\/js\/vendor\/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-79243751-1','auto');ga('send','pageview');}</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>