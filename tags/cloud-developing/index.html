<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>cloud developing &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="cloud developing"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="http://blog.jln.co/tags/cloud-developing/"><meta property="og:image" content="http://blog.jln.co/images/avatar.png"><meta property="og:updated_time" content="2016-11-23T12:05:38+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.jln.co/images/avatar.png"><meta name=twitter:title content="cloud developing"><meta name=twitter:description content><link rel=canonical href=http://blog.jln.co/tags/cloud-developing/><link href=http://blog.jln.co/tags/cloud-developing/feed.xml rel=alternate type=application/rss+xml title="Le murmure de Julian"><link href=http://blog.jln.co/tags/cloud-developing/feed.xml rel=feed type=application/rss+xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.73.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post-index><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i>Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i>GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i>Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>cloud developing</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-11-23 12:05:38 +0000 UTC"><a href=/Rate-limit-with-Go-and-Gin/>Nov 23, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Rate-limit-with-Go-and-Gin/ rel=bookmark title="Rate limit with Go and Gin" itemprop=url>Rate limit with Go and Gin</a></h1></header><div class=entry-content><p>昨天趁等著去面試前稍微把這之前想要寫一下的這題目打包成一個<a href=https://github.com/gin-gonic/gin>Gin</a>的middleware :</p><ul><li><a href=https://github.com/julianshen/gin-limiter>Gin-limiter</a></li></ul><p>Rate limiting 通常在很多開放API的服務內會常看到, 像是<a href=https://dev.twitter.com/rest/public/rate-limiting>Twitter</a>,
像是<a href=https://developers.facebook.com/docs/graph-api/advanced/rate-limiting>Facebook</a>或是<a href=http://open.weibo.com/wiki/Rate-limiting>新浪微博</a>,
其目的就是希望API不要被特定節點頻繁存取以致於造成伺服器端的過載</p><h3 id=rate-limiter->rate limiter</h3><p>一般的Rate limiting的設計大致上來說就是限制某一個特定的節點(或使用者或API Key等等)在一段特定的時間內的存取次數,
比如說, 限制一分鐘最多60次存取這樣的規則, 最直覺的方式我們是可以起一個timer和一個counter, counter大於60就限制存取, timer則每60秒重置counter一次,
看似這樣就好了, 但其實這有漏洞, 假設我在第59秒時瞬間存取了60次, 第61秒又瞬間存取了60次, 在這設計上是合法的, 因為counter在第60秒時就被重置了,
但實質上卻違反了一分鐘最多60次這限制, 因為他在兩秒內就存取了120次, 遠大於我們設計的限制, 當然我們也可以用Sliding time window來解決,
但那個實作上就稍稍複雜點</p><p>目前兩個主流比較常見的做法是<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>和<a href=https://en.wikipedia.org/wiki/Leaky_bucket>Leaky Bucket</a>,
這兩個原理上大同小異</p><p>先來說說<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>, 他的做法是, 假設你有個桶子, 裡面是拿來裝令牌(Token)的,
桶子不是Doraemon的四次元口袋, 所以他空間是有限的, 令牌(Token)的作用在於, 要執行命令的人, 如果沒從桶子內摸到令牌, 就不准執行,
然後我們一段時間內丟一些令牌進去, 如果桶子裡面已經裝滿就不丟, 以上個例子來說, 我們可以準備一個最多可以裝60個令牌的桶子, 每秒鐘丟一個進去,
如果消耗速度大於每秒一個, 自然桶子很快就乾了, 就沒牌子拿了</p><p><a href=https://en.wikipedia.org/wiki/Leaky_bucket>Leaky Bucket</a>跟<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>很像, 不過就是反過來,
我們把每次的存取都當作一滴水滴入桶子中, 桶子滿了就會溢出(拒絕存取), 桶子底下打個洞, 讓水以固定速率流出去, 這樣一樣能達到類似的效果</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/c/c4/Leaky_bucket_analogy.JPG alt="Leaky Bucket"></p><h3 id=go的rate-limiter實作->Go的rate limiter實作</h3><p>Go官方的package內其實是有rate limiter的實作的:</p><ul><li><a href=https://godoc.org/golang.org/x/time/rate>package rate</a></li></ul><p>照他的說法他是實作了<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>, <a href=https://godoc.org/golang.org/x/time/rate#NewLimiter>創建一個Limiter</a>,
要給的參數是<a href=https://godoc.org/golang.org/x/time/rate#Limit>Limit</a>和b, 這個Limit指的是每秒鐘丟多少Token進桶字(? 我不知道有沒理解錯),
而b是桶子的大小</p><p>實際上去用了之後發現好像也不是那麼好用, 可能我理解有問題, 出現的並不是我想像的結果, 因此我換用了<a href=https://github.com/juju/ratelimit>Juju&rsquo;s ratelimit</a>,
這個是在<a href=https://github.com/go-kit/kit>gokit</a>這邊看到它有用, 所以應該不會差到哪去, 一樣也是Token Bucket,給的參數就是多久餵一次牌子, 跟桶子的大小, 這就簡單用了一點</p><h3 id=包裝成gin-middleware->包裝成Gin middleware</h3><p>要套在web server上使用的話, 包裝成middleware是比較方便的, 因此我就花了點時間把<a href=https://github.com/juju/ratelimit>Juju&rsquo;s ratelimit</a>包裝成這個:</p><ul><li><a href=https://github.com/julianshen/gin-limiter>Gin-limiter</a></li></ul><p>使用範例如下:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#75715e>//Allow only 10 requests per minute per API-Key
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>lm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>limiter</span>.<span style=color:#a6e22e>NewRateLimiter</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>, <span style=color:#ae81ff>10</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
		<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-API-KEY&#34;</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>key</span>, <span style=color:#66d9ef>nil</span>
		}
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;API key is missing&#34;</span>)
	})
	<span style=color:#75715e>//Apply only to /ping
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/ping&#34;</span>, <span style=color:#a6e22e>lm</span>.<span style=color:#a6e22e>Middleware</span>(), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
			<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>,
		})
	})

	<span style=color:#75715e>//Allow only 5 requests per second per user
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>lm2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>limiter</span>.<span style=color:#a6e22e>NewRateLimiter</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#ae81ff>5</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
		<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-USER-TOKEN&#34;</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>key</span>, <span style=color:#66d9ef>nil</span>
		}
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;User is not authorized&#34;</span>)
	})

	<span style=color:#75715e>//Apply to a group
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Group</span>(<span style=color:#e6db74>&#34;/v2&#34;</span>)
	<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>lm2</span>.<span style=color:#a6e22e>Middleware</span>())
	{
		<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/ping&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
				<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>,
			})
		})
		<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/another_ping&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
				<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong pong&#34;</span>,
			})
		})
	}
</code></pre></div><p>這邊本來想說為了簡單理解一點把參數設計成"每分鐘不能超過10次"這樣的描述, 然後後面再轉換成實際的fillInterval, 不過好像覺得怪怪的,
有點不太符合Token Bucket的特質, 寫成middleware後的彈性就較大一點, 可以全部都用一個limiter或是分不同的資源不同限制都可</p><p>這邊建構時要傳入一個用來產生key的函數, 這是考慮到每個人想限制的依據不同, 例如根據API key, 或是session, 或是不同來源之類的, 由這函數去
產生一個對應的key來找到limiter, 如果傳回error, 就是這個request不符合規則, 直接把他拒絕掉</p><h3 id=跨server的rate-limit->跨server的rate limit</h3><p>這方法只能針對單一server, 但現在通常都是多台server水平擴展, 因此也是會需要橫跨server的解決方案, 這部分的話, 用Redis來實作Token Bucket是可行的, 這等下次再來弄好了</p></div></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="\/js\/vendor\/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-79243751-1','auto');ga('send','pageview');}</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>