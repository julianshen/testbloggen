<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>[Golang] 一個簡單的Mongo db proxy &#8211; Le murmure de Julian</title><meta name=description content><meta name=keywords content="golang,mongodb"><meta property="og:title" content="[Golang] 一個簡單的Mongo db proxy"><meta property="og:description" content="之前被Parse搞的半死, 一直很好奇它的API到Mongodb的request之間到底是怎樣的對應 要弄清楚這個其實也不難, 把Mongodb的"><meta property="og:type" content="article"><meta property="og:url" content="http://blog.jln.co/Golang-%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84Mongo-db-proxy/"><meta property="og:image" content="http://blog.jln.co/images/posts/2016-06-19-%5Bgolang%5D-%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84mongo-db-proxy.md.jpg"><meta property="article:published_time" content="2016-06-19T13:17:04+00:00"><meta property="article:modified_time" content="2016-06-19T13:17:04+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.jln.co/images/posts/2016-06-19-%5Bgolang%5D-%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84mongo-db-proxy.md.jpg"><meta name=twitter:title content="[Golang] 一個簡單的Mongo db proxy"><meta name=twitter:description content="之前被Parse搞的半死, 一直很好奇它的API到Mongodb的request之間到底是怎樣的對應 要弄清楚這個其實也不難, 把Mongodb的"><link rel=canonical href=http://blog.jln.co/Golang-%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84Mongo-db-proxy/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.73.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i>Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i>GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i>Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/Golang-%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84Mongo-db-proxy/ rel=bookmark title="[Golang] 一個簡單的Mongo db proxy">[Golang] 一個簡單的Mongo db proxy</a></h1><h2><span class="entry-date date published"><time datetime="2016-06-19 13:17:04 +0000 UTC">June 19, 2016</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>Reading time ~4 minutes</p></div></header><div class=entry-content><p>之前被Parse搞的半死, 一直很好奇它的API到Mongodb的request之間到底是怎樣的對應</p><p>要弄清楚這個其實也不難, 把Mongodb的profiler全打開去看log就好了(<code>db.setProfilingLevel(2)</code>), 但這也是有缺點, profiler會寫到<code>system.profile</code>這個collection去, 而它是固定大小, 不能無限制的放, 再加上它還要多寫入這段, 多多少少影響效能</p><p>我需要的是一個從外部來觀察的工具, 不會影響到DB本身, 並且也可以將網路本身所花費的時間也包含進去, 所以想到的是在中間插一個proxy server</p><p>在現成的工具找到一個叫<a href=https://github.com/christkv/mongodb-proxy>MonoDB Proxy</a>的工具, 這是用nodejs寫的, 勉強可以, 也證明了這個方法是可行的, 但這工具雖然有做到代理這部份, 但在log部分, 由於它並未解析bson, 所以詳細的內容並不好看, 所以就自己來寫一個</p><h4 id=功能需求>功能需求</h4><ol><li>支援<a href=https://docs.mongodb.com/manual/reference/mongodb-wire-protocol/>mongodb wire protocol</a>, 而不是只是單純的轉送資料</li><li>印出request跟response內JSON的內容</li><li>要能夠知道每個request所需要的時間(含網路)</li></ol><h4 id=成品>成品</h4><p>最後寫出的的成品在這: <a href=https://github.com/julianshen/mongoproxy>https://github.com/julianshen/mongoproxy</a></p><p>整個還蠻簡單的:</p><ol><li>wire.go 實作wire protocol</li><li>proxy.go 實作從client收資料並轉寫到server端</li><li>cmd/mp/main.go command line主程式的部分</li></ol><h4 id=使用方法>使用方法</h4><p>這個工具是用Go寫的, 所以使用之前需要先安裝go</p><h5 id=安裝>安裝</h5><p><code>go get julianshen/mongoproxy/mp</code></p><p>這個步驟做完後, 就可以把mp這個指令裝好了, 確定 $GOPATH/bin是在你路徑內, mp這個檔也是在那邊</p><h5 id=使用>使用</h5><p><code>mp --port=6001 --remote=mydb:27017 --response</code></p><p>其中:</p><ol><li>port是你這個proxy server的服務點</li><li>remote是遠端的mongodb (host:port)</li><li>Reponse是需不需要log回傳的部分</li></ol><h4 id=實作wire-protocol>實作Wire protocol</h4><p>本來覺得Wire protocol會蠻複雜的, 結果, 其實是蠻簡單的</p><p>所有的wire protocol request都會有一個標準的表頭:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> MsgHeader {
    int32   messageLength; <span style=color:#75715e>// total message size, including this
</span><span style=color:#75715e></span>    int32   requestID;     <span style=color:#75715e>// identifier for this message
</span><span style=color:#75715e></span>    int32   responseTo;    <span style=color:#75715e>// requestID from the original request
</span><span style=color:#75715e></span>                           <span style=color:#75715e>//   (used in responses from db)
</span><span style=color:#75715e></span>    int32   opCode;        <span style=color:#75715e>// request type - see table below
</span><span style=color:#75715e></span>}
</code></pre></div><p>對應golang, 我定義成這樣:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MsgHeader</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>MessageLength</span> <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// total message size, including this
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>RequestID</span>     <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// identifier for this message
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ResponseTo</span>    <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// requestID from the original request
</span><span style=color:#75715e></span>	<span style=color:#75715e>//   (used in responses from db)
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Opcode</span> <span style=color:#75715e>// request type - see table below
</span><span style=color:#75715e></span>}
</code></pre></div><p>因為一開始就可以讀到整個訊息長度的, 所以就蠻好解析的, wire protocol的實作我是有參考了<a href=https://github.com/facebookgo/dvara>dvara</a>, 本來是有想拿它的code來改, 但看了一下發現它也沒完整實作wire protocol, 秉著自己也來了解一下這部份的想法, 就重頭自己刻了</p><p>跟<a href=https://github.com/facebookgo/dvara>dvara</a>不同的地方是, 我用go的binary package來讀header而非自己刻一個, binary.Read的確是一個蠻好用的工具, 用底下的code就可以讀出header這個資料結構:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MsgHeader</span>{}
<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>h</span>)
</code></pre></div><p>另外, 除header外, 各request的所帶的欄位各自不同, 這部份的作法就是定好各個所需的資料結構, 用reflection的方式來讀取各相關資料:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>req</span>)
<span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Elem</span>()

<span style=color:#75715e>// 根據資料結構內定義的每個欄位用相關的方法讀取
</span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>NumField</span>(); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
    <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Field</span>(<span style=color:#a6e22e>i</span>)
    <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Type</span>()

    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bytesRead</span> <span style=color:#f92672>==</span> int(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>MessageLength</span>) {
        <span style=color:#66d9ef>break</span>
    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bytesRead</span> &gt; int(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>MessageLength</span>) {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>ErrorWrongLen</span>
    }

    <span style=color:#66d9ef>switch</span> {
    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>((<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>)(<span style=color:#66d9ef>nil</span>)):
        <span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>readDoc</span>(<span style=color:#a6e22e>bufferReader</span>)
</code></pre></div><h4 id=解析bson>解析bson</h4><p>這部份就沒再重新造輪子了, 直接用golang著名的mongodb driver mgo裡的bson lib: <a href=https://godoc.org/gopkg.in/mgo.v2/bson>https://godoc.org/gopkg.in/mgo.v2/bson</a> , 這個bson lib已經寫的很不錯了, 直接拿來用即可</p><p>在這個package內, 泛用的bson資料結構有兩種: <a href=https://godoc.org/gopkg.in/mgo.v2/bson#M><code>bson.M</code></a> 和 <a href=https://godoc.org/gopkg.in/mgo.v2/bson#D><code>bson.D</code></a></p><p>這兩個是不同用途的,仔細看一下M跟D的定義:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>M</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}
</code></pre></div><p>和</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>D</span> []<span style=color:#a6e22e>DocElem</span>
</code></pre></div><p>如果你是要把解析出的資料用map來操作, M是蠻方便的, 一開始我也是依著之前我寫相關的東西的習慣用M, 不過這邊卻是不可以用M的, 這也是我碰到bug的地方</p><p>由於M解析出的是Map, 所以每個field的順序它並沒記住, 但偏偏在wire protocol裡, 尤其是 $cmd, 順序是重要的, 所以Unmarshal出的M再Marshal回去, 順序可能不是原本的順序了, 而這在這個proxy應用上, client寫什麼東西過來就要寫什麼到server才不至於出錯</p><h4 id=測試和debug>測試和Debug</h4><p>我是用<a href=https://www.wireshark.org>Wireshark</a>來驗證我的實作有沒問題, Wireshark預設會把到27017 port的資料解析成wire protocol的內容供閱讀, 當然也可以自己手動請它解析</p><h4 id=其他應用>其他應用</h4><p>這樣的proxy應該可以不只應用在debug, 像是Parse open source的<a href=https://github.com/facebookgo/dvara>dvara</a>, 它也是利用了proxy來做connection pooling, 應該也可以用在request routing和caching的應用上</p><footer class=entry-meta><span class=entry-tags><a href=/tags/#golang title="Pages tagged golang" class=tag><span class=term>golang</span></a><a href=/tags/#mongodb title="Pages tagged mongodb" class=tag><span class=term>mongodb</span></a></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fblog.jln.co%2fGolang-%25E4%25B8%2580%25E5%2580%258B%25E7%25B0%25A1%25E5%2596%25AE%25E7%259A%2584Mongo-db-proxy%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i>Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=http%3a%2f%2fblog.jln.co%2fGolang-%25E4%25B8%2580%25E5%2580%258B%25E7%25B0%25A1%25E5%2596%25AE%25E7%259A%2584Mongo-db-proxy%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i>Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=http%3a%2f%2fblog.jln.co%2fGolang-%25E4%25B8%2580%25E5%2580%258B%25E7%25B0%25A1%25E5%2596%25AE%25E7%259A%2584Mongo-db-proxy%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=http://blog.jln.co/Golang-%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84Mongo-db-proxy/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="\/js\/vendor\/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-79243751-1','auto');ga('send','pageview');}</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>